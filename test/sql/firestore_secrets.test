# name: test/sql/firestore_secrets.test
# description: Test Firestore secret management
# group: [sql]

require fire_duck_ext

# ============================================
# API Key Authentication Secret Tests
# ============================================

# Test basic API key secret creation
statement ok
CREATE SECRET api_key_secret (
    TYPE firestore,
    PROJECT_ID 'my-project',
    API_KEY 'AIzaSyTestKey123'
);

# Test that secret was created
statement ok
DROP SECRET api_key_secret;

# ============================================
# Service Account Secret Tests
# ============================================

# Test service account JSON inline (minimal valid JSON structure)
statement ok
CREATE SECRET sa_inline (
    TYPE firestore,
    PROJECT_ID 'my-project',
    SERVICE_ACCOUNT_JSON '{"type":"service_account","project_id":"my-project","private_key_id":"key123","private_key":"-----BEGIN RSA PRIVATE KEY-----\ntest\n-----END RSA PRIVATE KEY-----\n","client_email":"test@my-project.iam.gserviceaccount.com"}'
);

statement ok
DROP SECRET sa_inline;

# ============================================
# Custom Database ID Tests
# ============================================

# Test custom database ID
statement ok
CREATE SECRET custom_db (
    TYPE firestore,
    PROJECT_ID 'my-project',
    API_KEY 'key123',
    DATABASE 'custom-database'
);

statement ok
DROP SECRET custom_db;

# Test default database ID (should work without DATABASE parameter)
statement ok
CREATE SECRET default_db (
    TYPE firestore,
    PROJECT_ID 'my-project',
    API_KEY 'key123'
);

statement ok
DROP SECRET default_db;

# ============================================
# Error Cases
# ============================================

# Test missing PROJECT_ID
statement error
CREATE SECRET missing_project (
    TYPE firestore,
    API_KEY 'key123'
);
----

# Test missing authentication (neither API_KEY nor SERVICE_ACCOUNT_JSON)
statement error
CREATE SECRET missing_auth (
    TYPE firestore,
    PROJECT_ID 'my-project'
);
----

# ============================================
# Secret Scope Tests
# ============================================

# Create a secret for use in subsequent tests
statement ok
CREATE SECRET test_secret (
    TYPE firestore,
    PROJECT_ID 'test-project',
    API_KEY 'test-key'
);

# Verify secret is available (will fail at runtime due to invalid key, but binding should work)
statement error
SELECT * FROM firestore_scan('users');
----

# Clean up
statement ok
DROP SECRET test_secret;
